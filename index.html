<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Seguimiento Ambiental y Social - MINEDUCYT / BCIE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0ea5e9; --accent: #10b981; --bg: #0f172a; --panel: #1e293b; --text: #f1f5f9; --glass: rgba(30, 41, 59, 0.9); }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; }
        
        #sidebar { width: 420px; background: var(--panel); border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 1000; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        header { padding: 25px 20px; background: linear-gradient(135deg, #004b8d 0%, #002d54 100%); text-align: center; border-bottom: 3px solid var(--primary); }
        header h1 { font-size: 0.85rem; margin: 0; text-transform: uppercase; letter-spacing: 1px; line-height: 1.5; color: white; }

        .upload-section { padding: 20px; background: rgba(0,0,0,0.2); }
        .file-label { display: flex; align-items: center; justify-content: center; gap: 12px; background: rgba(14, 165, 233, 0.1); border: 2px dashed var(--primary); color: var(--primary); padding: 14px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; text-transform: uppercase; font-size: 13px; }
        .file-label:hover { background: var(--primary); color: white; }

        #status { font-size: 11px; text-align: center; margin-top: 10px; padding: 8px; border-radius: 8px; font-weight: 500; }
        .status-loading { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .status-success { color: var(--accent); background: rgba(16, 185, 129, 0.1); }

        .scroll-content { padding: 15px; overflow-y: auto; flex: 1; }
        .filter-card { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #334155; }
        .filter-group label { display: block; font-size: 9px; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px; font-weight: 800; }
        
        select, input { width: 100%; background: #0f172a; border: 1px solid #475569; color: white; padding: 8px 10px; border-radius: 6px; font-size: 12px; outline: none; }

        #map-area { flex: 1; position: relative; }
        #map { height: 100%; width: 100%; background: #0b0f1a; }

        .stats-container { position: absolute; top: 20px; left: 20px; z-index: 1000; display: flex; gap: 15px; pointer-events: none; }
        .stat-card { background: var(--glass); backdrop-filter: blur(12px); padding: 12px 20px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .stat-card h3 { margin: 0; font-size: 9px; text-transform: uppercase; color: #94a3b8; }
        .stat-card p { margin: 5px 0 0; font-size: 1.8rem; font-weight: 800; color: var(--primary); }

        /* Estilos mejorados para Popup */
        .leaflet-popup-content-wrapper { background: var(--panel); color: white; border: 1px solid var(--primary); border-radius: 12px; }
        .leaflet-popup-tip { background: var(--panel); }
        .popup-info-grid { display: grid; grid-template-columns: 1fr; gap: 5px; margin-top: 10px; font-size: 11px; border-top: 1px solid #475569; padding-top: 10px; }
        .popup-info-item { display: flex; justify-content: space-between; border-bottom: 1px border-bottom: 1px solid rgba(255,255,255,0.05); padding: 2px 0; }
        .popup-info-label { color: #94a3b8; font-weight: bold; margin-right: 10px; }
        .popup-info-value { color: #f1f5f9; text-align: right; }
        
        .nav-btn { display: block; width: 100%; background: var(--primary); color: white !important; text-align: center; padding: 10px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 11px; margin-top: 12px; box-sizing: border-box; }
        .dist-info { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent); padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 11px; color: var(--accent); }
    </style>
</head>
<body>

<div id="sidebar">
    <header><h1>Seguimiento de condiciones ambientales y sociales<br>MINEDUCYT / BCIE</h1></header>
    <div class="upload-section">
        <label class="file-label">
            <span>üìÇ CARGAR DATOS (LOCAL)</span>
            <input type="file" id="fileInput" accept=".csv, .xlsx" style="display:none">
        </label>
        <div id="status" class="status-loading">Conectando con la base de datos...</div>
    </div>
    <div class="scroll-content">
        <div class="filter-card">
            <div class="filter-group">
                <label>üîé BUSCAR CENTRO / C√ìDIGO</label>
                <input type="text" id="mainSearch" placeholder="Escriba aqu√≠...">
            </div>
        </div>
        <div id="dynamicFilters"></div>
    </div>
</div>

<div id="map-area">
    <div id="map"></div>
    <div class="stats-container">
        <div class="stat-card"><h3>Total Centros</h3><p id="totalUniv">0</p></div>
        <div class="stat-card"><h3>Seleccionados</h3><p id="totalSel" style="color: var(--accent);">0</p></div>
    </div>
</div>

<script>
    let db = [];
    let userLocation = null;
    const colors = ["#0ea5e9", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#ec4899", "#06b6d4"];

    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQiyIjmU8Mpr4F3rnKa-y69G4Lf0wCk_FXo1GVgiFBSZI6rucPIG6PxVY9J5BjCYQ/pub?gid=1425429813&single=true&output=csv";
    const PROXY_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(SHEET_URL)}`;

    const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
    const streetMap = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}');
    const satelliteMap = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}');

    const map = L.map('map', { center: [13.79, -88.89], zoom: 9, zoomControl: false, layers: [darkMap] });
    L.control.layers({ "Modo Oscuro": darkMap, "Calles": streetMap, "Sat√©lite": satelliteMap }, null, { position: 'topright' }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    const markers = L.layerGroup().addTo(map);

    // Localizaci√≥n del usuario
    map.locate({setView: false});
    map.on('locationfound', (e) => userLocation = e.latlng);

    const filterConfig = [
        { lab: "Departamento", key: "Departamento" },
        { lab: "Etapa", key: "Etapa" },
        { lab: "Empresa obras", key: "Empresa obras" },
        { lab: "Empresa supervisi√≥n", key: "Empresa supervisi√≥n" },
        { lab: "PEGAS Elaboraci√≥n", key: "PEGAS Elaboraci√≥n" },
        { lab: "PEGAS Ejecuci√≥n", key: "PEGAS Ejecuci√≥n" },
        { lab: "Reubicaci√≥n Temporal", key: "Reubicaci√≥n Temporal" },
        { lab: "Administrador de contrato", key: "Administrador de contrato" }
    ];

    async function loadFromSheets() {
        const statusDiv = document.getElementById('status');
        try {
            Papa.parse(PROXY_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                    statusDiv.className = "status-success";
                    statusDiv.innerText = "‚úÖ Sincronizado con Google Sheets";
                }
            });
        } catch (e) { statusDiv.innerText = "‚ùå Error de conexi√≥n"; }
    }

    function processData(rawData) {
        db = rawData.map(row => {
            const cleanRow = {};
            // Limpieza de claves para manejar tildes y espacios ocultos de Google
            Object.keys(row).forEach(k => {
                const cleanKey = k.trim().replace(/\s+/g, ' ');
                cleanRow[cleanKey] = row[k];
            });
            let rawVal = String(cleanRow["Porcentaje de avance"] || "0").replace('%','').trim();
            cleanRow["Porcentaje de avance"] = parseFloat(rawVal) > 1 ? parseFloat(rawVal)/100 : parseFloat(rawVal);
            return cleanRow;
        });
        renderUI();
    }

    function renderUI() {
        document.getElementById('totalUniv').innerText = db.length;
        const container = document.getElementById('dynamicFilters');
        container.innerHTML = "";
        filterConfig.forEach(f => {
            const vals = [...new Set(db.map(r => r[f.key]))].filter(v => v && v !== "").sort();
            const div = document.createElement('div');
            div.className = "filter-card";
            div.innerHTML = `<div class="filter-group"><label>${f.lab}</label><select class="f-item" data-key="${f.key}"><option value="">-- Todos --</option>${vals.map(v => `<option value="${v}">${v}</option>`).join('')}</select></div>`;
            container.appendChild(div);
        });
        document.querySelectorAll('.f-item').forEach(s => s.onchange = update);
        document.getElementById('mainSearch').oninput = update;
        update();
    }

    function update() {
        markers.clearLayers();
        const search = document.getElementById('mainSearch').value.toLowerCase();
        
        const filtered = db.filter(row => {
            const matchSearch = !search || String(row["C√≥digo"]).toLowerCase().includes(search) || String(row["Centro Educativo"]).toLowerCase().includes(search);
            let matchFilters = true;
            document.querySelectorAll('.f-item').forEach(sel => { if(sel.value && String(row[sel.dataset.key]) !== sel.value) matchFilters = false; });
            return matchSearch && matchFilters;
        });

        filtered.forEach(row => {
            const lat = parseFloat(row["Latitud"]), lng = parseFloat(row["Longitud"]);
            if(!isNaN(lat) && !isNaN(lng)) {
                let distHtml = "";
                let mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                
                if(userLocation) {
                    const dKm = (userLocation.distanceTo([lat, lng])/1000).toFixed(1);
                    const time = Math.round((dKm * 1.5) + 5);
                    distHtml = `<div class="dist-info">üìè <b>Distancia:</b> ${dKm} km | ‚è±Ô∏è <b>Tiempo est.:</b> ${time} min</div>`;
                    mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${lat},${lng}`;
                }

                // Generaci√≥n de informaci√≥n completa del Popup basada en las columnas
                let detailsHtml = "";
                const exclude = ["Latitud", "Longitud", "Centro Educativo", "C√≥digo", "Porcentaje de avance"];
                Object.keys(row).forEach(key => {
                    if(!exclude.includes(key) && row[key]) {
                        detailsHtml += `<div class="popup-info-item"><span class="popup-info-label">${key}:</span><span class="popup-info-value">${row[key]}</span></div>`;
                    }
                });

                const dotColor = row["Porcentaje de avance"] >= 1 ? "#10b981" : "#0ea5e9";
                
                L.circleMarker([lat, lng], { radius: 7, fillColor: dotColor, color: "white", weight: 1.5, fillOpacity: 0.9 }).addTo(markers)
                .bindPopup(`
                    <div style="min-width:250px">
                        <b style="color:var(--primary); font-size:14px">${row["Centro Educativo"]}</b><br>
                        <small>C√≥digo: ${row["C√≥digo"]}</small>
                        
                        <div class="popup-info-grid">
                            <div class="popup-info-item"><span class="popup-info-label">Avance:</span><span class="popup-info-value" style="color:var(--accent); font-weight:bold">${(row["Porcentaje de avance"]*100).toFixed(1)}%</span></div>
                            ${detailsHtml}
                        </div>
                        
                        ${distHtml}
                        <a href="${mapsUrl}" target="_blank" class="nav-btn">üìç INICIAR NAVEGACI√ìN (Google Maps)</a>
                    </div>
                `);
            }
        });
        document.getElementById('totalSel').innerText = filtered.length;
    }

    window.onload = loadFromSheets;
</script>
</body>
</html>